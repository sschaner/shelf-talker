<ion-content class="home-background">
  <ion-grid>
    <ion-row>
      <ion-col size-sm="6" offset-sm="3">
        <h3 class="app-title">Shelf Talker</h3>
      </ion-col>
    </ion-row>
  </ion-grid>

  <!-- Account Linking Card - shown when Google login finds existing email/password account -->
  @if (linkingMode) {
  <div class="login-signup-card login-card">
    <form #linkForm="ngForm" (ngSubmit)="onLinkAccount()">
      <ion-grid>
        <ion-row>
          <ion-col size-sm="6" offset-sm="3">
            <h5 class="title">Link Your Account</h5>
          </ion-col>
        </ion-row>

        <ion-row>
          <ion-col size-sm="6" offset-sm="3">
            <div class="subtitle">CONNECT GOOGLE</div>
          </ion-col>
        </ion-row>

        <hr class="divider full-divider" />

        <ion-row>
          <ion-col size-sm="6" offset-sm="3">
            <p class="linking-message">
              An account already exists for <strong>{{ linkingEmail }}</strong>.
              Enter your password to link your Google account.
            </p>
          </ion-col>
        </ion-row>

        <!-- Password -->
        <ion-row>
          <ion-col size-sm="6" offset-sm="3">
            <ion-item class="item-input-wrapper" lines="none">
              <ion-input
                label="Password"
                label-placement="floating"
                [type]="showPassword ? 'text' : 'password'"
                name="linkPassword"
                [(ngModel)]="password"
                (ionInput)="clearError()"
                #linkPasswordModel="ngModel"
                required>
              </ion-input>
              <i
                slot="end"
                class="fa-solid password-icon"
                [class.fa-eye]="showPassword"
                [class.fa-eye-slash]="!showPassword"
                (click)="togglePassword()"
                aria-hidden="true">
              </i>
            </ion-item>

            @if (linkPasswordModel.touched && linkPasswordModel.invalid) {
            <p class="error-message">
              Please enter your password.
            </p>
            }
          </ion-col>
        </ion-row>

        <!-- Google Photo Option -->
        @if (googlePhotoURL) {
        <ion-row>
          <ion-col size-sm="6" offset-sm="3">
            <div class="google-photo-option">
              <img [src]="googlePhotoURL" alt="Google profile photo" class="google-photo-preview" />
              <ion-item lines="none" class="photo-checkbox-item">
                <ion-checkbox
                  [(ngModel)]="useGooglePhoto"
                  name="useGooglePhoto"
                  labelPlacement="end">
                  Use my Google photo
                </ion-checkbox>
              </ion-item>
            </div>
          </ion-col>
        </ion-row>
        }

        <ion-row>
          <ion-col size-sm="6" offset-sm="3">
            <ion-button
              type="submit"
              expand="block"
              color="primary"
              class="submit-button"
              [disabled]="linkForm.invalid || loading">
              {{ loading ? 'Please wait…' : 'Link Account' }}
            </ion-button>
            
            @if (error) {
            <p class="error-message">
              {{ error }}
            </p>
            }
          </ion-col>
        </ion-row>

        <ion-row>
          <ion-col size-sm="6" offset-sm="3">
            <ion-button
              type="button"
              expand="block"
              fill="outline"
              color="medium"
              (click)="cancelLinking()">
              Cancel
            </ion-button>
          </ion-col>
        </ion-row>
      </ion-grid>
    </form>
  </div>
  } @else {
  <!-- Normal Login Card -->
  <div class="login-signup-card login-card">
    <form #f="ngForm" (ngSubmit)="onLoginEmail()">
      <ion-grid>
        <ion-row>
          <ion-col size-sm="6" offset-sm="3">
            <h5 class="title">Welcome Back</h5>
          </ion-col>
        </ion-row>

        <ion-row>
          <ion-col size-sm="6" offset-sm="3">
            <div class="subtitle">LOGIN</div>
          </ion-col>
        </ion-row>

        <hr class="divider full-divider" />
        
        <!-- Email -->
        <ion-row>
          <ion-col size-sm="6" offset-sm="3">
            <ion-item class="item-input-wrapper" lines="none">
              <ion-input
                label="Email"
                label-placement="floating"
                type="email"
                name="email"
                [(ngModel)]="email"
                (ionInput)="clearError()"
                #emailModel="ngModel"
                required>
              </ion-input>
            </ion-item>

            @if (emailModel.touched && email && !emailPattern.test(email.trim().toLowerCase())) {
            <p class="error-message">
              Please enter a valid email address.
            </p>
            }
          </ion-col>
        </ion-row>

        <!-- Password -->
        <ion-row>
          <ion-col size-sm="6" offset-sm="3">
            <ion-item class="item-input-wrapper" lines="none">
              <ion-input
                label="Password"
                label-placement="floating"
                [type]="showPassword ? 'text' : 'password'"
                name="password"
                [(ngModel)]="password"
                (ionInput)="clearError()"
                #passwordModel="ngModel"
                required>
              </ion-input>
              <i
                slot="end"
                class="fa-solid password-icon"
                [class.fa-eye]="showPassword"
                [class.fa-eye-slash]="!showPassword"
                (click)="togglePassword()"
                aria-hidden="true">
              </i>
            </ion-item>

            @if (passwordModel.touched && passwordModel.invalid) {
            <p class="error-message">
              Please enter your password.
            </p>
            }
          </ion-col>
        </ion-row>

        <ion-row>
          <ion-col size-sm="6" offset-sm="3">
            <ion-button
              type="submit"
              expand="block"
              color="primary"
              class="submit-button"
              [disabled]="f.invalid || loading">
              {{ loading ? 'Please wait…' : 'Login' }}
            </ion-button>
            
            @if (error) {
            <p class="error-message">
              {{ error }}
            </p>
            }
          </ion-col>
        </ion-row>
      </ion-grid>
    </form>

    <ion-grid>
      <ion-row>
        <ion-col size-sm="6" offset-sm="3">
          <div class="or">
            <hr class="divider half-divider" />
            <div class="or-text">OR</div>
            <hr class="divider half-divider" />
          </div>
        </ion-col>
      </ion-row>

      <ion-row>
        <ion-col size-sm="6" offset-sm="3">
          <div class="external-auth-buttons">
            <button class="gsi-material-button" type="button" aria-label="Sign in with Google" (click)="onGoogle()">
              <div class="gsi-material-button-state"></div>
              <div class="gsi-material-button-content-wrapper">
                <div class="gsi-material-button-icon">
                  <svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" xmlns:xlink="http://www.w3.org/1999/xlink" style="display: block;">
                    <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path>
                    <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path>
                    <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path>
                    <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path>
                    <path fill="none" d="M0 0h48v48H0z"></path>
                  </svg>
                </div>
                <span class="gsi-material-button-contents">Sign in</span>
                <span style="display: none;">Sign in with Google</span>
              </div>
            </button>
          </div>
        </ion-col>

        <ion-col size-sm="6" offset-sm="3">
          <div class="external-auth-buttons">
            <button
              type="button"
              aria-label="Sign in with Microsoft"
              (click)="onMicrosoft()">
              <img src="../../../assets/ms-logo-and-sign-in-phrase.svg" alt="Sign in with Microsoft" />
            </button>
          </div>
        </ion-col>
      </ion-row>

      <ion-row>
        <ion-col size-sm="6" offset-sm="3">
          <div class="switch-auth">
            New user?
            <span class="signup-link" [routerLink]="['/sign-up']">Sign up</span>
          </div>
        </ion-col>
      </ion-row>
    </ion-grid>
  </div>
  }
</ion-content>
